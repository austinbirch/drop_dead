var SPACE=32;var ARROW={LEFT:37,UP:38,RIGHT:39,DOWN:40};var A=65;var D=68;var S=83;var R=82;var C=67;var GAME_RUNNING=1;var GAME_PAUSED=2;var GAME_OVER=3;var GAME_RUNNER_WON=4;var color_hash={red:"rgba(255, 0, 0, 0.3)",green:"rgba(0, 255, 0, 0.3)",blue:"rgba(0, 0, 255, 0.3)",fuchsia:"rgba(255, 0, 255, 0.3)",white:"rgba(255, 255, 255, 0.3)"};var Game=function(){this.game_timer;this.left_key_down=false;this.right_key_down=false;this.space_key_down=false;this.a_key_down=false;this.d_key_down=false;this.s_key_down=false;this.ai_on=false;this.status=GAME_RUNNING;this.gravity=0.5;this.previous_tick=0;this.current_tick=0;this.frames_per_second=60;this.current_fps=0;this.frames=0;this.accumulator=0;this.block_width=32;this.alert_message="";this.alert_opacity=0.7;this.imageManager=new ImageManager();this.imageManager.addImage("runnerImageWhite","./images/runnerWhite.png");this.imageManager.addImage("runnerImageFuchsia","./images/runnerFuchsia.png");this.imageManager.addImage("runnerImageGreen","./images/runnerGreen.png");this.imageManager.addImage("bg","./images/bg.png");this.imageManager.addImage("blockImage","./images/block-alt.png");this.imageManager.addImage("floorImage","./images/floor_two.png");this.imageManager.loadImages(this,this.initObjects)};Game.prototype.initObjects=function(){var f=this;this.background=new Background();this.background.setBackgroundImage(this.imageManager);this.floor=null;this.floor=new Floor();this.floor.setFloorImage(this.imageManager);this.target_height=null;this.player=new RunnerPlayer();this.player.setColor("white");this.player.setPlayerImage(f.imageManager);this.playerBlock=new BlockPlayer();this.playerBlock.setColor(color_hash.fuchsia);this.playerBlock.width=this.block_width;if(this.ai_on){this.AI=new AI();this.AI.block.width=this.block_width;this.AI.target_block_array=this.block_array}this.block_array=new Array();for(var d=2;d>0;d--){var e=new Block();e.setBlockImage(this.imageManager);e.setPosition(d*e.getWidth(),e.getHeight()*d);e.moving=true;this.block_array[d]=e}this.block_array[1].setColor(color_hash.red);this.block_array[2].setColor(color_hash.blue);this.initGame()};Game.prototype.initGame=function(){console.log("initGame");this.canvas=$("canvas");this.context=this.canvas.get(0).getContext("2d");this.canvas.attr("width",800);this.canvas.attr("height",500);this.floor.setWidth(canvas.width);this.floor.setPosition(0,(canvas.height-this.floor.getTileWidth()));this.target_height=(canvas.height/100)*22;this.ground=this.floor.position.y;this.player.setPosition(100,(this.floor.position.y-this.player.getHeight()));this.canvas.fadeIn(1000);this.timeout()};Game.prototype.restart_game=function(){clearTimeout(this.game_timer);this.previous_tick=0;this.current_tick=0;this.frames_per_second=60;this.current_fps=0;this.frames=0;this.accumulator=0;this.left_key_down=false;this.right_key_down=false;this.space_key_down=false;this.a_key_down=false;this.d_key_down=false;this.s_key_down=false;this.status=GAME_RUNNING;this.alert_message="";this.initObjects()};Game.prototype.timeout=function(){this.previous_tick=this.current_tick;this.current_tick=(new Date).getTime();if(this.previous_tick==0){}else{var c=(this.current_tick-this.previous_tick);this.accumulator=this.accumulator+c;if(this.accumulator>=1000){this.current_fps=this.frames;this.frames=1;this.accumulator=0}else{this.frames++}this.update(c/1000);this.draw()}var d=this;this.game_timer=setTimeout(function(){d.timeout()},1000/this.frames_per_second)};Game.prototype.update=function(m){if(this.status==GAME_RUNNING){var l=new Vector(this.player.position.x,this.player.position.y);if(this.player.jumping==false&&this.space_key_down==true){this.player.jumping=true;this.player.setVelocity(this.player.velocity.x,this.player.jump_speed)}if(this.player.jumping==true){if(this.player.position.y+this.player.velocity.y<(this.ground-this.player.getHeight())){this.player.position.y=this.player.position.y+this.player.velocity.y;this.player.setVelocity(this.player.velocity.x,this.player.velocity.y+this.gravity)}else{this.player.jumping=false;this.player.setPosition(this.player.position.x,this.ground-this.player.getHeight())}}else{for(var r=this.block_array.length-1;r>0;r--){var s=new Block();var n=false;s=this.block_array[r];var t=new Rect();t=this.player.getBoundingRect();t.height+=16;if(this.collisionDetect(t,s.getBoundingRect())){n=true;break}}if(n==false){this.player.jumping=true}}for(var r=this.block_array.length-1;r>0;r--){var s=new Block();s=this.block_array[r];if(this.collisionDetect(this.player.getBoundingRect(),s.getBoundingRect())){this.player.position.y=s.position.y-this.player.getHeight();this.player.velocity.y=this.gravity;this.player.jumping=false;break}}if(this.player.moving==false&&this.right_key_down==true){this.player.moving=true;this.player.setVelocity(+this.player.speed,this.player.velocity.y)}else{if(this.player.moving==false&&this.left_key_down==true){this.player.moving=true;this.player.setVelocity(-this.player.speed,this.player.velocity.y)}else{this.player.moving=false}}if(this.player.moving==true){var q=this.player.position.x+this.player.velocity.x;if(q>0&&q<(canvas.width-this.player.getWidth())){this.player.position.x=q;for(var r=(this.block_array.length-1);r>0;r--){var s=new Block();s=this.block_array[r];if(this.collisionDetect(this.player.getBoundingRect(),s.getBoundingRect())==true){if(this.player.velocity.x>0){this.player.position.x=s.position.x-this.player.getWidth()}else{if(this.player.velocity.x<0){this.player.position.x=s.position.x+s.getWidth()}}}}}}if(this.a_key_down==true){if(this.playerBlock.position.x>0){this.playerBlock.updatePosition(m,this.playerBlock.position.x-this.block_width)}}else{if(this.d_key_down==true){if(this.playerBlock.position.x<canvas.width-this.block_width){this.playerBlock.updatePosition(m,this.playerBlock.position.x+this.block_width)}}}if(this.s_key_down==true){this.playerBlock.fireBlock(m,this.block_array,this.imageManager)}for(var o=(this.block_array.length-1);o>0;o--){var s=new Block();s=this.block_array[o];if(s.moving==true){if(s.position.y<(this.ground-s.getHeight())){s.setVelocity(0,s.velocity.y+this.gravity);s.position.y=s.position.y+s.velocity.y;for(var p=(this.block_array.length-1);p>0;p--){var i=new Block();i=this.block_array[p];if(s!=i){if(this.collisionDetect(s.getBoundingRect(),i.getBoundingRect())==true){s.moving=false;s.velocity.y=0;s.position.y=i.position.y-s.getHeight()}}}if(this.collisionDetect(s.getBoundingRect(),this.player.getBoundingRect())){if(this.player.lives<=0){this.alert_message="YOU'RE DEAD!";this.status=GAME_OVER;if(this.alert_opacity!=0.7){this.alert_opacity=0.7}}else{this.alert_message="BOOM, HEADSHOT!";this.player.lives--;if(this.alert_opacity!=0.7){this.alert_opacity=0.7}}}}else{s.position.y=this.ground-s.getHeight();s.moving=false;s.velocity.y=0}}}if(this.ai_on){this.AI.update(m,this.player.position.x);if(this.AI.firing){this.AI.fire(m,this.block_array,this.imageManager)}}if((this.player.position.y+this.player.getHeight())<this.target_height&&this.player.lives>=0){this.status=GAME_RUNNER_WON;if(this.alert_opacity!=0.7){this.alert_opacity=0.7}}if(this.alert_message!=""){this.alert_opacity-=0.008;if(this.alert_opacity<0.02){this.alert_message="";this.alert_opacity=0.7}}}switch(this.status){case GAME_RUNNER_WON:this.alert_message="WIN! R TO RESTART";this.alert_opacity=0.7;break;case GAME_OVER:this.alert_message="DEAD! R TO RESTART";this.alert_opacity=0.7;break}};Game.prototype.draw=function(){this.canvas.width=this.canvas.width;this.background.draw(this.context);for(var d=(this.block_array.length-1);d>0;d--){var c=new Block();c=this.block_array[d];c.draw(this.context)}this.player.draw(this.context);this.playerBlock.draw(this.context);if(this.ai_on){this.AI.draw(this.context)}this.context.fillStyle="rgb(255, 255, 255)";this.context.font="12px Courier";this.context.fillText("fps: "+this.current_fps,10,20);if(this.ai_on){this.context.fillText("ai: on",(this.canvas.width()-100),35)}else{this.context.fillText("ai: off",(this.canvas.width()-100),35)}this.context.fillStyle="rgba(255, 255, 255, 0.5)";this.context.fillRect(0,this.target_height,this.canvas.width(),1);this.context.font="14px Courier";this.context.fillText("target line",10,this.target_height);this.floor.draw(this.context);if(this.alert_message!=""){this.context.font="64px Courier";this.context.fillStyle="rgba(255, 255, 255,"+this.alert_opacity+")";this.context.textAlign="center";this.context.fillText(this.alert_message,this.canvas.width()/2,this.canvas.height()/2);this.context.textAlign="left"}};Game.prototype.collisionDetect=function(c,d){leftA=c.x;rightA=c.x+c.width;topA=c.y;bottomA=c.y+c.height;leftB=d.x;rightB=d.x+d.width;topB=d.y;bottomB=d.y+d.height;if(bottomA<topB){return false}if(topA>bottomB){return false}if(rightA<leftB){return false}if(leftA>rightB){return false}return true};Game.prototype.keyDown=function(e){var f=e.keyCode;var d=e.data.self;switch(f){case ARROW.LEFT:d.left_key_down=true;break;case ARROW.RIGHT:d.right_key_down=true;break;case ARROW.DOWN:break;case ARROW.UP:break;case SPACE:d.space_key_down=true;break;case A:d.a_key_down=true;break;case D:d.d_key_down=true;break;case S:d.s_key_down=true;break}switch(f){case ARROW.LEFT:case ARROW.RIGHT:case ARROW.UP:case ARROW.DOWN:case SPACE:return false}};Game.prototype.keyUp=function(e){var f=e.keyCode;var d=e.data.self;switch(f){case ARROW.LEFT:d.left_key_down=false;break;case ARROW.RIGHT:d.right_key_down=false;break;case ARROW.DOWN:break;case ARROW.UP:break;case SPACE:d.space_key_down=false;break;case A:d.a_key_down=false;break;case D:d.d_key_down=false;break;case S:d.s_key_down=false;break;case R:console.log("R");d.restart_game();break;case C:if(d.ai_on==true){d.ai_on=false}else{d.ai_on=true}d.restart_game()}};