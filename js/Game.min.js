var SPACE=32;var ARROW={LEFT:37,UP:38,RIGHT:39,DOWN:40};var A=65;var D=68;var S=83;var R=82;var C=67;var GAME_RUNNING=1;var GAME_PAUSED=2;var GAME_OVER=3;var GAME_RUNNER_WON=4;var color_hash={red:"rgba(255, 0, 0, 0.3)",green:"rgba(0, 255, 0, 0.3)",blue:"rgba(0, 0, 255, 0.3)",fuchsia:"rgba(255, 0, 255, 0.3)",white:"rgba(255, 255, 255, 0.3)"};var Game=function(){this.game_timer;this.left_key_down=false;this.right_key_down=false;this.space_key_down=false;this.a_key_down=false;this.d_key_down=false;this.s_key_down=false;this.ai_on=false;this.status=GAME_RUNNING;this.gravity=0.5;this.previous_tick=0;this.current_tick=0;this.frames_per_second=60;this.current_fps=0;this.frames=0;this.accumulator=0;this.block_width=32;this.alert_message="";this.alert_opacity=0.7;this.imageManager=new ImageManager();this.imageManager.addImage("runnerImageWhite","./images/runnerWhite.png");this.imageManager.addImage("runnerImageFuchsia","./images/runnerFuchsia.png");this.imageManager.addImage("runnerImageGreen","./images/runnerGreen.png");this.imageManager.addImage("bg","./images/bg.png");this.imageManager.addImage("blockImage","./images/block-alt.png");this.imageManager.addImage("floorImage","./images/floor_two.png");this.imageManager.loadImages(this,this.initObjects)};Game.prototype.initObjects=function(){var b=this;this.background=new Background();this.background.setBackgroundImage(this.imageManager);this.floor=null;this.floor=new Floor();this.floor.setFloorImage(this.imageManager);this.target_height=null;this.player=new RunnerPlayer();this.player.setColor("white");this.player.setPlayerImage(b.imageManager);this.playerBlock=new BlockPlayer();this.playerBlock.setColor(color_hash.fuchsia);this.playerBlock.width=this.block_width;if(this.ai_on){this.AI=new AI();this.AI.block.width=this.block_width;this.AI.target_block_array=this.block_array}this.block_array=new Array();for(var a=2;a>0;a--){var c=new Block();c.setBlockImage(this.imageManager);c.setPosition(a*c.getWidth(),c.getHeight()*a);c.moving=true;this.block_array[a]=c}this.block_array[1].setColor(color_hash.red);this.block_array[2].setColor(color_hash.blue);this.initGame()};Game.prototype.initGame=function(){console.log("initGame");this.canvas=$("canvas");this.context=this.canvas.get(0).getContext("2d");this.canvas.attr("width",800);this.canvas.attr("height",500);this.floor.setWidth(canvas.width);this.floor.setPosition(0,(canvas.height-this.floor.getTileWidth()));this.target_height=(canvas.height/100)*22;this.ground=this.floor.position.y;this.player.setPosition(100,(this.floor.position.y-this.player.getHeight()));this.canvas.fadeIn(1000);this.timeout()};Game.prototype.restart_game=function(){clearTimeout(this.game_timer);this.previous_tick=0;this.current_tick=0;this.frames_per_second=60;this.current_fps=0;this.frames=0;this.accumulator=0;this.left_key_down=false;this.right_key_down=false;this.space_key_down=false;this.a_key_down=false;this.d_key_down=false;this.s_key_down=false;this.status=GAME_RUNNING;this.alert_message="";this.initObjects()};Game.prototype.timeout=function(){this.previous_tick=this.current_tick;this.current_tick=(new Date).getTime();if(this.previous_tick==0){}else{var b=(this.current_tick-this.previous_tick);this.accumulator=this.accumulator+b;if(this.accumulator>=1000){this.current_fps=this.frames;this.frames=1;this.accumulator=0}else{this.frames++}this.update(b/1000);this.draw()}var a=this;this.game_timer=setTimeout(function(){a.timeout()},1000/this.frames_per_second)};Game.prototype.update=function(k){if(this.status==GAME_RUNNING){var a=new Vector(this.player.position.x,this.player.position.y);if(this.player.jumping==false&&this.space_key_down==true){this.player.jumping=true;this.player.setVelocity(this.player.velocity.x,this.player.jump_speed)}if(this.player.jumping==true){if(this.player.position.y+this.player.velocity.y<(this.ground-this.player.getHeight())){this.player.position.y=this.player.position.y+this.player.velocity.y;this.player.setVelocity(this.player.velocity.x,this.player.velocity.y+this.gravity)}else{this.player.jumping=false;this.player.setPosition(this.player.position.x,this.ground-this.player.getHeight())}}else{for(var e=this.block_array.length-1;e>0;e--){var d=new Block();var j=false;d=this.block_array[e];var c=new Rect();c=this.player.getBoundingRect();c.height+=16;if(this.collisionDetect(c,d.getBoundingRect())){j=true;break}}if(j==false){this.player.jumping=true}}for(var e=this.block_array.length-1;e>0;e--){var d=new Block();d=this.block_array[e];if(this.collisionDetect(this.player.getBoundingRect(),d.getBoundingRect())){this.player.position.y=d.position.y-this.player.getHeight();this.player.velocity.y=this.gravity;this.player.jumping=false;break}}if(this.player.moving==false&&this.right_key_down==true){this.player.moving=true;this.player.setVelocity(+this.player.speed,this.player.velocity.y)}else{if(this.player.moving==false&&this.left_key_down==true){this.player.moving=true;this.player.setVelocity(-this.player.speed,this.player.velocity.y)}else{this.player.moving=false}}if(this.player.moving==true){var f=this.player.position.x+this.player.velocity.x;if(f>0&&f<(canvas.width-this.player.getWidth())){this.player.position.x=f;for(var e=(this.block_array.length-1);e>0;e--){var d=new Block();d=this.block_array[e];if(this.collisionDetect(this.player.getBoundingRect(),d.getBoundingRect())==true){if(this.player.velocity.x>0){this.player.position.x=d.position.x-this.player.getWidth()}else{if(this.player.velocity.x<0){this.player.position.x=d.position.x+d.getWidth()}}}}}}if(this.a_key_down==true){if(this.playerBlock.position.x>0){this.playerBlock.updatePosition(k,this.playerBlock.position.x-this.block_width)}}else{if(this.d_key_down==true){if(this.playerBlock.position.x<canvas.width-this.block_width){this.playerBlock.updatePosition(k,this.playerBlock.position.x+this.block_width)}}}if(this.s_key_down==true){this.playerBlock.fireBlock(k,this.block_array,this.imageManager)}for(var h=(this.block_array.length-1);h>0;h--){var d=new Block();d=this.block_array[h];if(d.moving==true){if(d.position.y<(this.ground-d.getHeight())){d.setVelocity(0,d.velocity.y+this.gravity);d.position.y=d.position.y+d.velocity.y;for(var g=(this.block_array.length-1);g>0;g--){var b=new Block();b=this.block_array[g];if(d!=b){if(this.collisionDetect(d.getBoundingRect(),b.getBoundingRect())==true){d.moving=false;d.velocity.y=0;d.position.y=b.position.y-d.getHeight()}}}if(this.collisionDetect(d.getBoundingRect(),this.player.getBoundingRect())){if(this.player.lives<=0){this.alert_message="YOU'RE DEAD!";this.status=GAME_OVER;if(this.alert_opacity!=0.7){this.alert_opacity=0.7}}else{this.alert_message="BOOM, HEADSHOT!";this.player.lives--;if(this.alert_opacity!=0.7){this.alert_opacity=0.7}}}}else{d.position.y=this.ground-d.getHeight();d.moving=false;d.velocity.y=0}}}if(this.ai_on){this.AI.update(k,this.player.position.x);if(this.AI.firing){this.AI.fire(k,this.block_array,this.imageManager)}}if((this.player.position.y+this.player.getHeight())<this.target_height&&this.player.lives>=0){this.status=GAME_RUNNER_WON;if(this.alert_opacity!=0.7){this.alert_opacity=0.7}}if(this.alert_message!=""){this.alert_opacity-=0.008;if(this.alert_opacity<0.02){this.alert_message="";this.alert_opacity=0.7}}}switch(this.status){case GAME_RUNNER_WON:this.alert_message="WIN! R TO RESTART";this.alert_opacity=0.7;break;case GAME_OVER:this.alert_message="DEAD! R TO RESTART";this.alert_opacity=0.7;break}};Game.prototype.draw=function(){this.canvas.width=this.canvas.width;this.background.draw(this.context);for(var a=(this.block_array.length-1);a>0;a--){var b=new Block();b=this.block_array[a];b.draw(this.context)}this.player.draw(this.context);this.playerBlock.draw(this.context);if(this.ai_on){this.AI.draw(this.context)}this.context.fillStyle="rgb(255, 255, 255)";this.context.font="12px Courier";this.context.fillText("fps: "+this.current_fps,10,20);if(this.ai_on){this.context.fillText("ai: on",(this.canvas.width()-100),35)}else{this.context.fillText("ai: off",(this.canvas.width()-100),35)}this.context.fillStyle="rgba(255, 255, 255, 0.5)";this.context.fillRect(0,this.target_height,this.canvas.width(),1);this.context.font="14px Courier";this.context.fillText("target line",10,this.target_height);this.floor.draw(this.context);if(this.alert_message!=""){this.context.font="64px Courier";this.context.fillStyle="rgba(255, 255, 255,"+this.alert_opacity+")";this.context.textAlign="center";this.context.fillText(this.alert_message,this.canvas.width()/2,this.canvas.height()/2);this.context.textAlign="left"}};Game.prototype.collisionDetect=function(b,a){leftA=b.x;rightA=b.x+b.width;topA=b.y;bottomA=b.y+b.height;leftB=a.x;rightB=a.x+a.width;topB=a.y;bottomB=a.y+a.height;if(bottomA<topB){return false}if(topA>bottomB){return false}if(rightA<leftB){return false}if(leftA>rightB){return false}return true};Game.prototype.keyDown=function(c){var b=c.keyCode;var a=c.data.self;switch(b){case ARROW.LEFT:a.left_key_down=true;break;case ARROW.RIGHT:a.right_key_down=true;break;case ARROW.DOWN:break;case ARROW.UP:break;case SPACE:a.space_key_down=true;break;case A:a.a_key_down=true;break;case D:a.d_key_down=true;break;case S:a.s_key_down=true;break}switch(b){case ARROW.LEFT:case ARROW.RIGHT:case ARROW.UP:case ARROW.DOWN:case SPACE:return false}};Game.prototype.keyUp=function(c){var b=c.keyCode;var a=c.data.self;switch(b){case ARROW.LEFT:a.left_key_down=false;break;case ARROW.RIGHT:a.right_key_down=false;break;case ARROW.DOWN:break;case ARROW.UP:break;case SPACE:a.space_key_down=false;break;case A:a.a_key_down=false;break;case D:a.d_key_down=false;break;case S:a.s_key_down=false;break;case R:console.log("R");a.restart_game();break;case C:if(a.ai_on==true){a.ai_on=false}else{a.ai_on=true}a.restart_game()}};